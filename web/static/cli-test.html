<html>
  <head>
    <link rel="icon" href="/favicon.ico" type="image/png"/>
    <link rel="shortcut icon" href="/favicon.ico" type="image/png"/>

    <style type="text/css" title="currentStyle" media="screen">
	@import url("/themes/black-tie/jquery-ui-black-tie.css");
	@import url("/themes/black-tie/addons-black-tie.css");
	@import url("/static/cmd.css");
    </style>

    <script type="text/javascript" src="/jquery/jquery.js"></script>
    <script type="text/javascript" src="/jquery/jquery.mruPulldown.js"></script>
    <script type="text/javascript" src="/jquery/jquery-ui.js"></script>

    <script type="text/javascript">

jQuery(function ($) {
    var dbgpr_inited = 0;
    dbgpr("document is ready");

    /*
     * There are three areas in the main display: the target list,
     * the command, and the command output.  Their use is highly
     * interrelated.
     *
     * XXX Need more here
     */

    var $top = $('#input-top');
    var $output_top = $('#output-top');
    var $cmd = $('#command-top');
    var $input = $('#input-form');
    var $target = $('#target-top');
    var $command_line = $('#command-line');

    var $target_history = $('#target-history-form');
    var $command_history = $('#command-history-data');
    var command_number = 0;
    var cmdHistory, tgtHistory;

    function command_init () {
        /* The "clear" icons wipe the values clear for target and command */
        $('.icon-clear-target', $top).click(function () {
            $input[0].target.value = "";
            $('#command-target').focus();
        });
        $('.icon-clear-command', $top).click(function () {
            $input[0].command.value = "";
            $('#command-line').focus();
        });

        cmdHistory = $.mruPulldown({
            name: "command-history",
            top: $('#command-top'),
            entryClass: "command-history-entry",
            click: function (me) {
                if (tgtHistory)
                    tgtHistory.close();
            },
        });

        tgtHistory = $.mruPulldown({
            name: "target-history",
            top: $('#target-top'),
            multiple: $('#target-history-form'),
            history: $('#target-history'),
            entryClass: "target-history-entry",
            focusAfter: $command_line,
            click: function (me) {
                if (cmdHistory)
                    cmdHistory.close();
            },
        });

        $input.submit(commandSubmit);

        $('#target-title').click(function () {
            tgtHistory.pulldown();
        });
    }                     

    function commandSubmit (event) {
        event.preventDefault();

        tgtHistory.close();
        cmdHistory.close();

        if (this.command.value == "") {
            dbgpr('submit; skipping since command value is empty');
            $command_line.focus();
            return false;
        }

        /*
         * Since multiple targets are allowed in the target field,
         * we need to break the target string up into distinct values.
         */
        var count = 0;
        var tset = [ ];
        var tname = "";
        var cname = "";
        var value = this.command.value;
        $(this.target.value.split(" ")).each(function (i, x) {
            if (x != "") {
                count += 1;
                tset.push(x);
                commmand_wrapper_add(x, value);
                tgtHistory.markUsed(x);
                tname += " " + x;
                cname += "_" + x.replace("_", "__", "g");
            }
        });

        tname = tname.substr(1);
        cname = cname.substr(1);
        if (cname && cname != "")
            target_list_mark_used(this, tname, cname);

        cmdHistory.markUsed(value);
        command_output_trim(count);

        return false;
    }

    /*
     * The target history displays a list of previous targets, ordered
     * by the MRU.  Individual target name can be selected, or the
     * boxes and submit can be used to enter multiple targets.
     */
    var target_history_shown = false;

    function target_history_click (event, $this) {
        var top, left, width;
        if (!$this)
            $this = $('#command-target', $top);

        top = $this.offset().top + $this.outerHeight();
        left = $this.offset().left;
        width = $this.outerWidth();

        dbgpr("target history click: ", top, left);

        target_history_shown = !target_history_shown;
        if (target_history_shown) {
            $('#target-history').css({
                top: top,
                left: left,
                width: width,
                display: "block",
            });
        } else {
            target_history_submit(null);
        }
    }

    /* XXX This is not working */
    $('#target-history').keydown(function (e) {
        if (e.keyCode == 13) {
            target_history_submit(e);
            return false;
        }
        if (e.keyCode == 27) {
            target_history_submit(e, true);
            return false;
        }
    });

    function target_history_submit (event, nochange) {
        if (event)
            event.preventDefault();

        target_history_shown = false;
        $('#target-history').css({ display: "none" });

        var tname = "";

        $('input:checked', $target_history).each(function () {
            if (this.name)
                tname += " " + this.name;
            $(this).removeAttr('checked');
        });

        if (nochange)
            return;

        if (tname != "")
            target_set($input.get(0), tname.substr(1));
        else
            $('#command-target').focus();

    }

    function target_list_mark_used (form, target, cname) {
        var $tset = $('#target-contents');
        var id = 'target-is-' + cname;
        var $target = $('#' + id, $tset);

        if ($target && $target.length > 0) {
            $target.remove();
            $tset.prepend($target);

        } else {

            var content = '<div id="' + id + '" class="target ' + id 
                + ' target-info rounded buttonish green">'
                + target
                + '</div>';

            var $target = jQuery(content);
            $tset.prepend($target);
            target_list_trim($tset);
        }

        $target.click(function (event) {
            tgtHistory.close();
            target_set(form, target);
        });

        $('#target-contents-none').css({ display: "none" });
    }

    function target_list_trim ($tset) {
        $('.target', $tset).each(function (index, target) {
            var delta = $(target).position().top - 
                        $(target).parent().position().top;
            if ( delta > prefs.max_target_position) {
                $(target).remove();
            }
        });     
    }

    function target_set (form, target) {
        dbgpr("target_set:", target);
        tgtHistory.select(target);
        $command_line.focus();
    }

    function command_set (line) {
        dbgpr("comand_set:", line);
        cmdHistory.select(line).focus();
    }

    function commmand_wrapper_add (target, command) {
        var content = '<div class="command-wrapper rounded">'
                + '<div class="icon-box">'
                + '<img src="/icons/button-remove.png" '
                +       'class="icon icon-remove-section"/>'
                + '<img src="/icons/button-keeper.png" '
                +       'class="icon keeper icon-keeper-section"/>'
                + '<img src="/icons/button-hide.png" '
                +       'class="icon icon-hide-section hidden"/>'
                + '<img src="/icons/button-unhide.png" '
                +       'class="icon icon-unhide-section"/>'
                + '</div>';

        if (target) {
            content += '<div class="command-target rounded buttonish green">'
                + target
                + '</div><div class="label"> -> </div>';
        }

        content += '<div class="command command-line rounded blue">'
                + command
                + '</div><div class="command-number">'
                + " (" + ++command_number + ")"
                + '</div><div class="command-output can-hide" '
                +    'style="white-space: pre-wrap">';

        if (prefs.live_action) {
            content += '<img src="/icons/loading.png">';
            content += "    ....loading...\n";
        } else {
            content += "test-output\nmore\nand more and more\noutput\n";
        }

        content += '</div>';

        var $newp = jQuery(content);
	$output_top.prepend($newp);
	$newp.slideUp(0).slideDown(prefs.slide_speed);

        div_unhide($newp);

        if (prefs.live_action) {
            var $out = $(".command-output", $newp);
            $out.slideUp(0).slideDown(prefs.slide_speed);

      	    $out.load("/bin/cmd.slax",
                      { target: target, command: command, form: "false" },
                      function (text, status, http) {
                          dbgpr("target", target);
                          dbgpr("command", command);
                          dbgpr("text", text);
                          dbgpr("status", status);
                          dbgpr("http", http);
                          if (status == "error") {
                              $(this).html('<div class="command-error">'
                                           + 'An error occurred: '
                                           + http.statusText
                                           + '</div>');
                          } else {
                              var $xml = $($.parseXML(text));
                              var $err = $xml.find("[nodeName='xnm:error']");
                              if ($err[0])
                                  $(this).html('<div class="command-error">'
                                     + 'An error occurred: '
                                     + html_escape($("message", $err).text())
                                     + '</div>');
                          }
                          $out.slideDown(prefs.slide_speed);
                      });
        }

        $('.icon-remove-section', $newp).click(function () {
            div_remove($newp);
        });
        $('.icon-keeper-section', $newp).click(function () {
            $newp.toggleClass("keeper-active");
        });
        $('.icon-unhide-section', $newp).click(function () {
            div_unhide($newp);
        });
        $('.icon-hide-section', $newp).click(function () {
            div_hide($newp);
        });

        $('.command-target', $newp).click(function () {
            target_set($input.get(0), $(this).text());
        });

        $('.command-line', $newp).click(function () {
            command_set($(this).text());
        });

        return false;
    }

    function html_escape (val) {
        return val.replace(/&/g, "&amp;")
                  .replace(/</g, "&lt;")
                  .replace(/>/g, "&gt;");
    }

    function command_output_trim_changed () {
        command_output_trim(0);
    }

    function command_output_trim (fresh_count) {
        var last = $('.contents', $cmd).get(0);
        if (!last)
            return;

        var keep = 0;
        for (var i = 0; last.children[i]; i++) {
            var $child = $(last.children[i]);
            if ($child.hasClass("keeper-active")) {
                keep += 1;
            } else if (i < fresh_count) {
                /* do nothing */
            } else if (i >= prefs.output_remove_after + keep) {
                div_remove($child);
            } else if (i >= prefs.output_close_after + keep) {
                if (!div_is_hidden($child))
                    div_hide($child);
            } else {
                if (div_is_hidden($child))
                    div_unhide($child);
            }
        }
    }

    function div_remove ($wrapper) {
        $wrapper.slideUp(prefs.slide_speed, function () {
            $wrapper.remove();
        });
    }

    function div_is_hidden ($wrapper) {
        return $('.icon-hide-section', $wrapper).hasClass("hidden");
    }

    function div_hide ($wrapper) {
        $('.icon-unhide-section', $wrapper).removeClass("hidden");
        $('.icon-hide-section', $wrapper).addClass("hidden");
        $('.can-hide', $wrapper).slideUp(prefs.slide_speed);
    }

    function div_unhide ($wrapper) {
        $('.icon-unhide-section', $wrapper).addClass("hidden");
        $('.icon-hide-section', $wrapper).removeClass("hidden");
        $('.can-hide', $wrapper).slideDown(prefs.slide_speed);
    }

    /*----------------------------------------------------------------------
     * Preferences allow customizable behavior.  We have our preferences
     * described in the array "prefs_info".  We keep the current values in
     * the "prefs" array.
     *
     * XXX need to make radio buttons, pulldowns, etc for enum types.
     * Need to add ranges.  Need verifiation code.  Probably should
     * use the forms plugin.
     */

    var prefs_info = {
        output_close_after: { def: 5, type: "number",
                              change: command_output_trim_changed,
                              title: "Number of open commands" },
        output_remove_after: { def: 10, type: "number",
                               change: command_output_trim_changed,
                               title: "Total Number of commands" },
        slide_speed: { def: "fast", type: "number-plus",
                       title: "Speed of slide animations" },
        max_commands_list: { def: 40, type: "number",
                            title: "Number of commands kept in list" },
        max_targets_inline: { def: 10, type: "number",
                              title: "Number of targets kept on screen" },
        max_targets_list: { def: 40, type: "number",
                            title: "Number of targets kept in list" },
        max_target_position: { def: 10, type: "number",
                               title: "Target button rows" },
        stay_on_page: { def: false, type: "boolean",
                        change: function (value, first) {
                            setupConfirmExit();
                        },
                        title: "Give warning if leaving this page" },
        live_action: { def: false, type: "boolean",
                        title: "Interact with real devices" },
    }

    var prefs = { }

    var prefs_shown = false;
    var prefs_form_built = false;

    function prefs_init () {
        for (var key in prefs_info) {
            prefs[key] = prefs_info[key].def;
            if (prefs_info[key].change)
                prefs_info[key].change(prefs_info[key].def, true);
        }

        $('#prefs').button().click(prefs_edit);
    }

    function prefs_edit (event) {
        event.preventDefault();

        var $this = $(this);
        var $pform = $('#prefs-form');

        prefs_shown = !prefs_shown;
        if (prefs_shown) {
            var form = $pform.get(0);

            if (!prefs_form_built) {
                prefs_form_built = true;
                for (var key in prefs_info) {
                    var info = prefs_info[key];
                    var content = '<div class="prefs-item">'
                        + '<label for="' + key + '">' + info.title
                        + '</label>'
                        + '<input name="' + key + '" type="text"/>'
                        + '<br/></div>';
                    var $target = jQuery(content);
                    $pform.prepend($target);
                }
            }

            for (var key in prefs_info) {
                form[key].value = prefs[key];
            }

            $pform.parent().css({
                display: "block",
                top: $this.offset().top + 30,
                left: $this.offset().left - 400,
                width: "400px",
                "background-color": "#ffffff",
            });

            $pform.submit(function (event) {
                event.preventDefault();
                prefs_shown = false;
                $pform.parent().css({ display: "none" });

                for (var key in prefs_info) {
                    var info = prefs_info[key];
                    prefs_set_value(info, key, this[key].value, info.type);
                }
            });

            $('#prefs-restore').click(function (event) {
                event.preventDefault();

                dbgpr("prefs-restore");
                for (var key in prefs_info) {
                    prefs[key] = prefs_info[key].def;
                    if (prefs_info[key].change)
                        prefs_info[key].change(prefs_info[key].def, false);
                    form[key].value = prefs_info[key].def;
                }
            });

        } else {
            $pform.parent().css({ display: "none" });
        }
    }

    function prefs_set_value (info, name, value, type) {
        if (type == "boolean") {
            value = (value == "true");
            if (prefs[name] == value)
                return;
        } else {
            var ival = parseInt(value);

            if (!isNaN(ival)) {
                if (prefs[name] == ival)
                    return;
                value = ival;

            } else if (type == "number-plus") {
                if (prefs[name] == value)
                    return;
            }
        }

        dbgpr("prefs: ", name, "set to", value, "; was ", prefs[name]);
        prefs[name] = value;
        if (info.change)
            info.change(value, true);
    }

    /*
     * dbgpr() is our old-and-trusted debug print function
     */
    function dbgpr () {
        if (dbgpr_inited == 0) {
            dbgpr_inited = 1;
            var $dc = $('#debug-container');
            var $dl = $('#debug-log');

            $('.icon-remove-section', $dc).button({
                text: false,
                icons: { primary: 'ui-icon-closethick' },
            }).click(function () {
                div_remove($dc);
            }).next().button({
                text: false,
                icons: { primary: 'ui-icon-minusthick' },
            }).click(function () {
                div_hide($dc);
            }).next().button({
                text: false,
                icons: { primary: 'ui-icon-plusthick' },
            }).click(function () {
                div_unhide($dc);
            }).addClass("hidden").next().button({
                text: false,
                icons: { primary: 'ui-icon-trash' },
            }).click(function () {
                $('.can-hide', $dc).text("");
            });
        }

        var args = Array.prototype.slice.call(arguments);
        $('#debug-log').prepend(args.join(" ") + "\n");
    }

    function setupConfirmExit () {
        if (prefs.stay_on_page) {
            window.onbeforeunload = function (e) {
                return "Are you sure?  You don't look sure.....";
            }
        } else {
            window.onbeforeunload = null;
        }
    }

    /* Keyboard handling code */

    function key_previous (e, input) {
        dbgpr("key_previous called\n");
    }

    var MOD_CTRL = 0x100;
    var MOD_META = 0x200;

    var keybinding = { };
    keybinding['p'] = key_previous,
    key_previous[MOD_CTRL | 77] = key_previous;

    $('#xxcommand-line').keydown(function (e) {
        dbgpr("press", e.ctrlKey ? "C-" : "", 
              (e.altKey || e.metaKey) ? "M-" : "",e.keyCode, 
              "(", e.charCode, ")");

        var code = e.keyCode;
        if (e.ctrlKey)
            code += MOD_CTRL;
        if (e.altKey || e.metaKey)
            code += MOD_META;

        if (keybinding[code])
            return keybinding[e.keyCode](e, this);
    });

    prefs_init();
    command_init();
    $('#command-target').focus();
});


    </script>
  </head>
  <body>

    <div id="header">
      <div id="header-logo">&nbsp;</div>
      <div id="header-info" class="ui-widget ui-corner-all">
	<div>User: phil</div>
	<div>Status: running</div>
      </div>
      <div id="header-actions">
	<button id="prefs">Edit Preferences</button>
      </div>
      <div id="prefs-form-wrapper" style="display: none" class="blue rounded">
	<div id="prefs-title">Preferences</div>
	<form id="prefs-form" action="#">
	  <input id="prefs-submit" name="submit" type="submit" value="Apply"/>
	  <button id="prefs-restore" name="restore">Restore Defaults</button>
	</form>
      </div>
    </div>

    <div id="content-wrapper">
      <div id="input-top" class="ui-widget ui-corner-all">
	<div id="target-list">
	  <div id="target-title" 
               class="target-info rounded green buttonish">Recent Targets:</div>
	  <div id="target-contents-none">None</div>
	  <div id="target-contents"></div>
	</div>

	<div id="target-history" style="display: none" class="green rounded">
	  <div class="empty">No targets have been entered</div>
	  <form id="target-history-form" action="#">
	    <div class="contents"></div>
	    <input type="submit" id="target-history-submit" 
		   value="Select Target(s)"/>
	  </form>
	</div>

	<form id="input-form" action="#">
	  <div id="target-top" class="history">
	    <div class="label">On:</div>
	    <img src="/icons/button-remove.png" class="icon icon-clear"/>
	    <input spellcheck="false" autocomplete="off" id="command-target"
		   class="command-target input text-entry rounded green"
		   maxlength="256" name="target" size="16" type="text"/>
	    <img src="/icons/button-pulldown.png" class="icon icon-pulldown"/>
	  </div>

	  <div id="command-top">
	    <div id="command-history" style="display: none"
		 class="history command-line rounded blue">
	      <div class="empty">No commands have been entered</div>
	      <div class="contents" style="display: none"></div>
	    </div>
	    <div class="label">Run:</div>
	    <img src="/icons/button-remove.png" class="icon icon-clear"/>
	    <input spellcheck="false" autocomplete="off" id="command-line"
		   class="command-line input text-entry rounded blue"
		   maxlength="2048" name="command" size="60" type="text"/>
	    <img src="/icons/button-pulldown.png" class="icon icon-pulldown"/>
	  </div>
	  <input type="submit" value="Enter"/>
	</form>
      </div>

      <div id="output-top"></div>
    </div>

    <div id="footer">
      [ Copyright 2011, Juniper Networks ]
    </div>

    <div id="debug-container" class="ui-widget ui-corner-all">
      <div class="ui-widget-header ui-corner-all">
	<button class="icon-remove-section">Close</button>
	<button class="icon-hide-section">Hide</button>
	<button class="icon-unhide-section">Show</button>
	<button class="icon-clean-section">Clean</button>
	<div id="debug-title">Debug Log:</div>
      </div>
      <div id="debug-log" class="can-hide">&nbsp;</div>
    </div>

  </body>
</html>
